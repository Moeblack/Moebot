# 处理器与决策

处理逻辑决定了机器人何时说话、说什么以及如何处理并发消息。

## 处理器 (Processor)

处理器位于 `bot_agent/handlers/processor.py`，其核心职能是**防抖 (Debounce)** 和 **批处理 (Batching)**。

- **工作机制**: 当收到消息时，处理器不会立即回复，而是开启一个计时器（如 3-5秒）。如果期间有新消息，则重置计时器并将消息存入队列。
- **好处**: 避免 AI 在用户分段发送多条消息时产生多次回复，使其更像人类在阅读完一段话后统一响应。

## 准入决策 (Entry Decision)

在决定生成回复之前，系统会运行一个轻量级的决策流程：

1.  **主动采样**: 如果不是被 @ 且不在“专注模式”，有 10% 的概率记录背景但不回复。
2.  **AI 判定**: 调用 LLM 判定当前对话是否需要机器人介入。
    - **回复指令**: 返回 `reply: true`。
    - **表情指令**: 返回 `emoji_id` 进行表情表态。
    - **专注模式**: 返回 `enter_focus: true` 使机器人在接下来的一段时间内更积极地回复该会话。

## 回复执行 (Reply Execution)

生成的回复支持多种形式：
- **纯文本**: 直接回复。
- **表情回应**: 在思考或确认时发送表情。
- **消息撤回**: 自动撤回中间状态的提示表情。

## 专注模式 (Focus Mode)

- **触发**: 由决策逻辑或指令触发。
- **效果**: 在专注模式下，机器人对所有该会话的消息都会进行处理，不再受随机采样的限制。
- **退出**: 长时间无交互或达到交互次数上限后自动退出。
